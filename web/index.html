<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Difference Comparison Analysis System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- 引入腾讯云COS SDK -->
  <script src="cos-js-sdk-v5.min.js"></script>
  
  <!-- Tailwind 配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#36CFC9',
            danger: '#F53F3F',
            warning: '#FF7D00',
            success: '#00B42A',
            dark: '#1D2129',
            light: '#F2F3F5'
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .upload-area-active {
        @apply border-primary bg-primary/5;
      }
      .image-container {
        @apply relative overflow-hidden bg-light rounded-lg shadow-inner;
      }
      .diff-marker {
        @apply absolute border-2 border-danger bg-danger/10 pointer-events-none transition-all duration-300;
      }
      .btn-primary {
        @apply bg-primary hover:bg-primary/90 text-white font-medium py-2 px-6 rounded-lg transition-all duration-300 transform hover:scale-105 active:scale-95 shadow-md hover:shadow-lg;
      }
      .btn-secondary {
        @apply bg-white hover:bg-gray-50 text-dark border border-gray-200 font-medium py-2 px-6 rounded-lg transition-all duration-300 transform hover:scale-105 active:scale-95 shadow-sm hover:shadow;
      }
      .card {
        @apply bg-white rounded-xl shadow-md hover:shadow-lg transition-all duration-300 overflow-hidden;
      }
      .progress-bar {
        @apply h-2 bg-primary rounded-full transition-all duration-300 ease-out;
      }
      .ocr-status {
        @apply text-sm mt-2 flex items-center justify-center hidden;
      }
    }
  </style>
</head>

<body class="font-inter bg-gray-50 text-dark min-h-screen flex flex-col">
  <!-- 顶部导航栏 -->
  <header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <i class="fa fa-picture-o text-primary text-2xl"></i>
        <h1 class="text-xl md:text-2xl font-bold text-primary">Image Difference Comparison Analysis System</h1>
      </div>
      <div class="hidden md:flex items-center space-x-4">
        <button id="helpBtn" class="text-gray-600 hover:text-primary transition-colors">
          <i class="fa fa-question-circle mr-1"></i>Help
        </button>
        <button id="aboutBtn" class="text-gray-600 hover:text-primary transition-colors">
          <i class="fa fa-info-circle mr-1"></i>About
        </button>
      </div>
    </div>
  </header>

  <!-- 主内容区域 -->
  <main class="flex-grow container mx-auto px-4 py-8">
    <!-- 上传页面 -->
    <section id="uploadPage" class="max-w-6xl mx-auto">
      <div class="text-center mb-8">
        <h2 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold mb-2">Upload Images for Difference Analysis</h2>
        <p class="text-gray-600 max-w-2xl mx-auto">Please upload two images, the system will automatically analyze and mark text difference areas in the images</p>
      </div>
      
      <div class="grid md:grid-cols-2 gap-8 mb-8">
        <!-- 第一张图片上传区域 -->
        <div class="card p-6">
          <h3 class="text-lg font-semibold mb-4 flex items-center">
            <i class="fa fa-image text-primary mr-2"></i>
            Reference Image
            <span class="ml-2 text-sm font-normal text-gray-500">(First)</span>
          </h3>
          
          <div id="uploadArea1" class="upload-area border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-primary transition-colors duration-300 mb-4 min-h-[200px] flex flex-col items-center justify-center">
            <i class="fa fa-cloud-upload text-4xl text-gray-400 mb-3"></i>
            <p class="text-gray-500 mb-2">Click or drag image here to upload</p>
            <p class="text-xs text-gray-400">Supports JPG, PNG, WEBP formats, max 10MB</p>
            <input type="file" id="imageInput1" accept="image/jpeg, image/png, image/webp" class="hidden" />
          </div>
          
          <!-- 上传进度 -->
          <div id="progressContainer1" class="hidden mb-4">
            <div class="flex justify-between text-sm mb-1">
              <span id="fileName1" class="text-gray-600 truncate"></span>
              <span id="progressPercent1" class="text-primary font-medium">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div id="progressBar1" class="progress-bar w-0"></div>
            </div>
          </div>
          
          <!-- OCR状态 -->
          <div id="ocrProcessing1" class="ocr-status text-primary">
            <i class="fa fa-spinner fa-spin mr-1"></i> Recognizing text in image...
          </div>
          <div id="ocrSuccess1" class="ocr-status text-success">
            <i class="fa fa-check-circle mr-1"></i> Text recognition completed
          </div>
          <div id="ocrError1" class="ocr-status text-danger">
            <i class="fa fa-exclamation-circle mr-1"></i> <span id="ocrErrorMessage1"></span>
          </div>
          
          <!-- 预览区域 -->
          <div id="previewContainer1" class="hidden">
            <div class="relative">
              <img id="previewImage1" src="" alt="Reference image preview" class="max-w-full max-h-[300px] mx-auto rounded-lg" />
              <button id="removeImage1" class="absolute -top-3 -right-3 bg-danger text-white rounded-full w-6 h-6 flex items-center justify-center shadow-md hover:bg-danger/80 transition-colors">
                <i class="fa fa-times text-xs"></i>
              </button>
            </div>
          </div>
          
          <!-- 上传状态提示 -->
          <div id="uploadSuccess1" class="hidden text-success text-sm mt-2 flex items-center justify-center">
            <i class="fa fa-check-circle mr-1"></i> Upload successful
          </div>
          <div id="uploadError1" class="hidden text-danger text-sm mt-2 flex items-center justify-center">
            <i class="fa fa-exclamation-circle mr-1"></i> <span id="errorMessage1"></span>
          </div>
        </div>
        
        <!-- 第二张图片上传区域 -->
        <div class="card p-6">
          <h3 class="text-lg font-semibold mb-4 flex items-center">
            <i class="fa fa-image text-primary mr-2"></i>
            Comparison Image
            <span class="ml-2 text-sm font-normal text-gray-500">(Second)</span>
          </h3>
          
          <div id="uploadArea2" class="upload-area border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-primary transition-colors duration-300 mb-4 min-h-[200px] flex flex-col items-center justify-center">
            <i class="fa fa-cloud-upload text-4xl text-gray-400 mb-3"></i>
            <p class="text-gray-500 mb-2">Click or drag image here to upload</p>
            <p class="text-xs text-gray-400">Supports JPG, PNG, WEBP formats, max 10MB</p>
            <input type="file" id="imageInput2" accept="image/jpeg, image/png, image/webp" class="hidden" />
          </div>
          
          <!-- 上传进度 -->
          <div id="progressContainer2" class="hidden mb-4">
            <div class="flex justify-between text-sm mb-1">
              <span id="fileName2" class="text-gray-600 truncate"></span>
              <span id="progressPercent2" class="text-primary font-medium">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div id="progressBar2" class="progress-bar w-0"></div>
            </div>
          </div>
          
          <!-- OCR状态 -->
          <div id="ocrProcessing2" class="ocr-status text-primary">
            <i class="fa fa-spinner fa-spin mr-1"></i> Recognizing text in image...
          </div>
          <div id="ocrSuccess2" class="ocr-status text-success">
            <i class="fa fa-check-circle mr-1"></i> Text recognition completed
          </div>
          <div id="ocrError2" class="ocr-status text-danger">
            <i class="fa fa-exclamation-circle mr-1"></i> <span id="ocrErrorMessage2"></span>
          </div>
          
          <!-- 预览区域 -->
          <div id="previewContainer2" class="hidden">
            <div class="relative">
              <img id="previewImage2" src="" alt="Comparison image preview" class="max-w-full max-h-[300px] mx-auto rounded-lg" />
              <button id="removeImage2" class="absolute -top-3 -right-3 bg-danger text-white rounded-full w-6 h-6 flex items-center justify-center shadow-md hover:bg-danger/80 transition-colors">
                <i class="fa fa-times text-xs"></i>
              </button>
            </div>
          </div>
          
          <!-- 上传状态提示 -->
          <div id="uploadSuccess2" class="hidden text-success text-sm mt-2 flex items-center justify-center">
            <i class="fa fa-check-circle mr-1"></i> Upload successful
          </div>
          <div id="uploadError2" class="hidden text-danger text-sm mt-2 flex items-center justify-center">
            <i class="fa fa-exclamation-circle mr-1"></i> <span id="errorMessage2"></span>
          </div>
        </div>
      </div>
      
      <!-- 分析按钮 -->
      <div class="text-center">
        <button id="analyzeBtn" class="btn-primary disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100" disabled>
          <i class="fa fa-line-chart mr-2"></i>Start Difference Analysis
        </button>
      </div>
      
      <!-- 分析进度 -->
      <div id="analysisProgress" class="hidden mt-8 max-w-2xl mx-auto text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary mx-auto mb-4"></div>
        <h3 class="text-lg font-medium mb-2">Analyzing image differences...</h3>
        <p class="text-gray-600">Please wait, the system is processing your images and performing detailed comparison analysis</p>
      </div>
    </section>
    
    <!-- 结果展示页面 -->
    <section id="resultPage" class="hidden max-w-7xl mx-auto">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-[clamp(1.5rem,3vw,2rem)] font-bold">Difference Analysis Results</h2>
        <button id="backToUploadBtn" class="btn-secondary">
          <i class="fa fa-arrow-left mr-2"></i>Back to Upload
        </button>
      </div>
      
      <!-- 图片对比区域 -->
      <div class="grid md:grid-cols-2 gap-6 mb-8">
        <!-- 第一张图片 -->
        <div class="card p-4">
          <h3 class="text-lg font-semibold mb-3 flex items-center">
            <i class="fa fa-image text-primary mr-2"></i>
            Reference Image
          </h3>
          
          <div class="image-container relative" style="height: 800px;">
            <img id="resultImage1" src="" alt="Reference image" class="absolute top-0 left-0 max-w-none" />
            
            <!-- 差异标记将动态添加到这里 -->
            <div id="diffMarkers1" class="absolute top-0 left-0 w-full h-full pointer-events-none"></div>
          </div>
        </div>
        
        <!-- 第二张图片 -->
        <div class="card p-4">
          <h3 class="text-lg font-semibold mb-3 flex items-center">
            <i class="fa fa-image text-primary mr-2"></i>
            Comparison Image
          </h3>
          
          <div class="image-container relative" style="height: 800px;">
            <img id="resultImage2" src="" alt="Comparison image" class="absolute top-0 left-0 max-w-none" />
            
            <!-- 差异标记将动态添加到这里 -->
            <div id="diffMarkers2" class="absolute top-0 left-0 w-full h-full pointer-events-none"></div>
          </div>
        </div>
      </div>
      
      <!-- 图片操作工具栏 -->
      <div class="flex flex-wrap justify-center gap-4 mb-8 bg-white p-4 rounded-lg shadow-sm">
        <button id="resetZoomBtn" class="btn-secondary flex items-center">
          <i class="fa fa-refresh mr-2"></i>Reset View
        </button>
        <span class="text-gray-600 self-center ml-4">Tip: You can drag images to view different areas</span>
      </div>
      
      <!-- 差异列表 -->
      <div class="card p-6 mb-8">
        <h3 class="text-lg font-semibold mb-4 flex items-center">
          <i class="fa fa-list-alt text-primary mr-2"></i>
          Text Difference Details
        </h3>
        
        <div id="noDifferences" class="hidden text-center py-10">
          <i class="fa fa-check-circle text-success text-4xl mb-3"></i>
          <p class="text-gray-600">No text differences found between the two images</p>
        </div>
        
        <div id="differencesList" class="space-y-4">
          <!-- 差异项将动态添加到这里 -->
        </div>
      </div>
      
      <!-- 分析结果操作 -->
      <div class="flex flex-wrap justify-center gap-4">
        <button id="downloadReportBtn" class="btn-primary flex items-center">
          <i class="fa fa-download mr-2"></i>Download Analysis Report
        </button>
        <button id="newAnalysisBtn" class="btn-secondary flex items-center">
          <i class="fa fa-plus mr-2"></i>New Analysis
        </button>
      </div>
    </section>
    
    <!-- 空状态/错误状态 -->
    <div id="emptyState" class="hidden text-center py-16 max-w-2xl mx-auto">
      <i class="fa fa-picture-o text-gray-300 text-6xl mb-4"></i>
      <h3 class="text-xl font-semibold mb-2">No image analysis performed yet</h3>
      <p class="text-gray-500 mb-6">Please upload two images and click the "Start Difference Analysis" button</p>
      <button id="startAnalysisBtn" class="btn-primary">
        <i class="fa fa-upload mr-2"></i>Upload Images
      </button>
    </div>
    
    <div id="errorState" class="hidden text-center py-16 max-w-2xl mx-auto">
      <i class="fa fa-exclamation-triangle text-warning text-6xl mb-4"></i>
      <h3 class="text-xl font-semibold mb-2">Analysis Failed</h3>
      <p id="errorStateMessage" class="text-gray-500 mb-6">Sorry, an error occurred during image analysis, please try again</p>
      <button id="retryAnalysisBtn" class="btn-primary">
        <i class="fa fa-refresh mr-2"></i>Retry
      </button>
    </div>
  </main>

  <!-- 页脚 -->
  <footer class="bg-white border-t border-gray-200 py-6">
    <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
      <p>© 2023 Image Difference Comparison Analysis System | Built with Tencent Cloud OCR and ADP Services</p>
    </div>
  </footer>

  <!-- 帮助模态框 -->
  <div id="helpModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b">
        <div class="flex justify-between items-center">
          <h3 class="text-xl font-bold">User Guide</h3>
          <button id="closeHelpModal" class="text-gray-500 hover:text-gray-700">
            <i class="fa fa-times text-xl"></i>
          </button>
        </div>
      </div>
      <div class="p-6">
        <h4 class="font-semibold text-lg mb-3">How to use the system for image difference analysis?</h4>
        <ol class="list-decimal pl-5 space-y-3 mb-4">
          <li>Upload a reference image and a comparison image in their respective upload areas</li>
          <li>The system will automatically upload the images and recognize text within them</li>
          <li>After both images are processed, click the "Start Difference Analysis" button</li>
          <li>The system will automatically process and display the analysis results</li>
          <li>On the results page, you can view marked difference areas and detailed text differences</li>
        </ol>
        
        <h4 class="font-semibold text-lg mb-3">Supported Image Formats</h4>
        <p class="mb-4">The system supports JPG, PNG, and WEBP format images, with a maximum file size of 10MB per image.</p>
      </div>
    </div>
  </div>

  <!-- 关于模态框 -->
  <div id="aboutModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl max-w-md w-full">
      <div class="p-6 border-b">
        <div class="flex justify-between items-center">
          <h3 class="text-xl font-bold">About System</h3>
          <button id="closeAboutModal" class="text-gray-500 hover:text-gray-700">
            <i class="fa fa-times text-xl"></i>
          </button>
        </div>
      </div>
      <div class="p-6">
        <div class="text-center mb-4">
          <i class="fa fa-picture-o text-primary text-4xl mb-2"></i>
          <h4 class="text-lg font-semibold">Image Difference Comparison Analysis System</h4>
          <p class="text-gray-500 text-sm">Version 1.0.0</p>
        </div>
        
        <p class="text-gray-600 mb-4">
          This system is used to compare and analyze text differences between two images, automatically marking difference areas and displaying detailed text changes.
        </p>
        
        <p class="text-gray-600">
          The system is built with Tencent Cloud OCR services and ADP services, providing efficient and accurate image text recognition and difference analysis.
        </p>
      </div>
    </div>
  </div>

  <script>
    // 全局状态管理
    const state = {
      images: {
        1: {
          file: null,
          url: null,
          uploaded: false,
          ocrCompleted: false,
          ocrResult: null,
          width: 0,
          height: 0,
          cosKey: null
        },
        2: {
          file: null,
          url: null,
          uploaded: false,
          ocrCompleted: false,
          ocrResult: null,
          width: 0,
          height: 0,
          cosKey: null
        }
      },
      analysisResults: null,
      currentZoom: 1,
      currentPosition: { x: 0, y: 0 },
      isDragging: false,
      dragStart: { x: 0, y: 0 },
      cos: null
    };

    // DOM 元素
    const elements = {
      // 上传页面元素
      uploadPage: document.getElementById('uploadPage'),
      uploadArea1: document.getElementById('uploadArea1'),
      uploadArea2: document.getElementById('uploadArea2'),
      imageInput1: document.getElementById('imageInput1'),
      imageInput2: document.getElementById('imageInput2'),
      progressContainer1: document.getElementById('progressContainer1'),
      progressContainer2: document.getElementById('progressContainer2'),
      fileName1: document.getElementById('fileName1'),
      fileName2: document.getElementById('fileName2'),
      progressBar1: document.getElementById('progressBar1'),
      progressBar2: document.getElementById('progressBar2'),
      progressPercent1: document.getElementById('progressPercent1'),
      progressPercent2: document.getElementById('progressPercent2'),
      previewContainer1: document.getElementById('previewContainer1'),
      previewContainer2: document.getElementById('previewContainer2'),
      previewImage1: document.getElementById('previewImage1'),
      previewImage2: document.getElementById('previewImage2'),
      removeImage1: document.getElementById('removeImage1'),
      removeImage2: document.getElementById('removeImage2'),
      uploadSuccess1: document.getElementById('uploadSuccess1'),
      uploadSuccess2: document.getElementById('uploadSuccess2'),
      uploadError1: document.getElementById('uploadError1'),
      uploadError2: document.getElementById('uploadError2'),
      errorMessage1: document.getElementById('errorMessage1'),
      errorMessage2: document.getElementById('errorMessage2'),
      
      // OCR状态元素
      ocrProcessing1: document.getElementById('ocrProcessing1'),
      ocrProcessing2: document.getElementById('ocrProcessing2'),
      ocrSuccess1: document.getElementById('ocrSuccess1'),
      ocrSuccess2: document.getElementById('ocrSuccess2'),
      ocrError1: document.getElementById('ocrError1'),
      ocrError2: document.getElementById('ocrError2'),
      ocrErrorMessage1: document.getElementById('ocrErrorMessage1'),
      ocrErrorMessage2: document.getElementById('ocrErrorMessage2'),
      
      analyzeBtn: document.getElementById('analyzeBtn'),
      analysisProgress: document.getElementById('analysisProgress'),
      
      // 结果页面元素
      resultPage: document.getElementById('resultPage'),
      resultImage1: document.getElementById('resultImage1'),
      resultImage2: document.getElementById('resultImage2'),
      diffMarkers1: document.getElementById('diffMarkers1'),
      diffMarkers2: document.getElementById('diffMarkers2'),
      differencesList: document.getElementById('differencesList'),
      noDifferences: document.getElementById('noDifferences'),
      backToUploadBtn: document.getElementById('backToUploadBtn'),
      newAnalysisBtn: document.getElementById('newAnalysisBtn'),
      downloadReportBtn: document.getElementById('downloadReportBtn'),
      
      // 图片操作按钮
      zoomInBtn: document.getElementById('zoomInBtn'),
      zoomOutBtn: document.getElementById('zoomOutBtn'),
      resetZoomBtn: document.getElementById('resetZoomBtn'),
      fitToScreenBtn: document.getElementById('fitToScreenBtn'),
      
      // 状态页面
      emptyState: document.getElementById('emptyState'),
      errorState: document.getElementById('errorState'),
      errorStateMessage: document.getElementById('errorStateMessage'),
      startAnalysisBtn: document.getElementById('startAnalysisBtn'),
      retryAnalysisBtn: document.getElementById('retryAnalysisBtn'),
      
      // 模态框
      helpBtn: document.getElementById('helpBtn'),
      aboutBtn: document.getElementById('aboutBtn'),
      helpModal: document.getElementById('helpModal'),
      aboutModal: document.getElementById('aboutModal'),
      closeHelpModal: document.getElementById('closeHelpModal'),
      closeAboutModal: document.getElementById('closeAboutModal')
    };

    // 初始化COS配置
    async function initCOS() {
      try {
        // 从后端获取临时密钥
        // const tempKeys = await getTemporaryKeys();
        
        // 初始化COS实例
        // state.cos = new COS({
        //   getAuthorization: function (options, callback) {
        //     callback({
        //       TmpSecretId: tempKeys.TmpSecretId,
        //       TmpSecretKey: tempKeys.TmpSecretKey,
        //       SecurityToken: tempKeys.SecurityToken,
        //       ExpiredTime: tempKeys.ExpiredTime
        //     });
        //   }
        // });
        state.cos = new COS({
          SecretId:'IKIDpXN7ez6GJAnCQSGsGTSDnCUuIj4HwY9n',
          SecretKey:'Zq088xb4LSNzTjldAsW0MYWJsHTTIyRk'
        });
        
        console.log('COS初始化成功');
        return true;
      } catch (error) {
        console.error('COS初始化失败:', error);
        showGlobalError('Unable to connect to object storage service, please try again later');
        return false;
      }
    }

    // 获取临时密钥
    async function getTemporaryKeys() {
      // 实际应用中，应从后端接口获取临时密钥
      console.log('获取临时密钥...');
      
      // 模拟后端接口返回临时密钥
      return new Promise(resolve => {
        setTimeout(() => {
          resolve({
            TmpSecretId: 'AKIDEXAMPLE',
            TmpSecretKey: 'EXAMPLEKEY',
            SecurityToken: 'EXAMPLETOKEN',
            ExpiredTime: Math.floor(Date.now() / 1000) + 3600
          });
        }, 500);
      });
      
      // 实际使用时应类似下面的代码：
      // const response = await fetch('/api/get-cos-temp-keys');
      // if (!response.ok) throw new Error('获取临时密钥失败');
      // return response.json();
    }

    // 初始化事件监听
    async function initEventListeners() {
      // 初始化COS
      const cosInitialized = await initCOS();
      if (!cosInitialized) return;
      
      // 上传区域点击事件
      elements.uploadArea1.addEventListener('click', () => elements.imageInput1.click());
      elements.uploadArea2.addEventListener('click', () => elements.imageInput2.click());
      
      // 文件选择事件
      elements.imageInput1.addEventListener('change', (e) => handleFileSelection(e, 1));
      elements.imageInput2.addEventListener('change', (e) => handleFileSelection(e, 2));
      
      // 拖拽事件
      setupDragDrop(elements.uploadArea1, 1);
      setupDragDrop(elements.uploadArea2, 2);
      
      // 移除图片事件
      elements.removeImage1.addEventListener('click', () => removeImage(1));
      elements.removeImage2.addEventListener('click', () => removeImage(2));
      
      // 分析按钮事件
      elements.analyzeBtn.addEventListener('click', startAnalysis);
      
      // 返回上传页面事件
      elements.backToUploadBtn.addEventListener('click', showUploadPage);
      elements.newAnalysisBtn.addEventListener('click', showUploadPage);
      elements.startAnalysisBtn.addEventListener('click', showUploadPage);
      elements.retryAnalysisBtn.addEventListener('click', startAnalysis);
      
      // 图片操作事件
      // elements.zoomInBtn.addEventListener('click', zoomIn);
      // elements.zoomOutBtn.addEventListener('click', zoomOut);
      elements.resetZoomBtn.addEventListener('click', resetZoom);
      // elements.fitToScreenBtn.addEventListener('click', fitToScreen);
      
      // 图片拖拽事件
      setupImageDrag();
      
      // 模态框事件
      elements.helpBtn.addEventListener('click', () => elements.helpModal.classList.remove('hidden'));
      elements.aboutBtn.addEventListener('click', () => elements.aboutModal.classList.remove('hidden'));
      elements.closeHelpModal.addEventListener('click', () => elements.helpModal.classList.add('hidden'));
      elements.closeAboutModal.addEventListener('click', () => elements.aboutModal.classList.add('hidden'));
      
      // 点击模态框外部关闭
      elements.helpModal.addEventListener('click', (e) => {
        if (e.target === elements.helpModal) elements.helpModal.classList.add('hidden');
      });
      elements.aboutModal.addEventListener('click', (e) => {
        if (e.target === elements.aboutModal) elements.aboutModal.classList.add('hidden');
      });
      
      // 下载报告事件
      elements.downloadReportBtn.addEventListener('click', downloadReport);
      
      // 窗口大小变化时重新适应图片
      window.addEventListener('resize', fitToScreen);
    }

    // 设置拖拽功能
    function setupDragDrop(uploadArea, imageId) {
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('upload-area-active');
      });
      
      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('upload-area-active');
      });
      
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('upload-area-active');
        
        if (e.dataTransfer.files.length) {
          const file = e.dataTransfer.files[0];
          handleFile(file, imageId);
        }
      });
    }

    // 处理文件选择
    function handleFileSelection(e, imageId) {
      if (e.target.files.length) {
        const file = e.target.files[0];
        handleFile(file, imageId);
      }
    }

    // 处理文件上传
    function handleFile(file, imageId) {
      // 重置之前的状态
      resetImageState(imageId);
      
      // 验证文件类型
      const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
      if (!validTypes.includes(file.type)) {
        showError(imageId, 'Unsupported file format, please upload JPG, PNG or WEBP format images');
        return;
      }
      
      // 验证文件大小 (10MB)
      if (file.size > 10 * 1024 * 1024) {
        showError(imageId, 'File size exceeds limit, please upload images no larger than 10MB');
        return;
      }
      
      // 显示文件名和进度条
      const fileNameEl = imageId === 1 ? elements.fileName1 : elements.fileName2;
      const progressContainer = imageId === 1 ? elements.progressContainer1 : elements.progressContainer2;
      
      fileNameEl.textContent = file.name;
      progressContainer.classList.remove('hidden');
      
      // 生成预览图
      const reader = new FileReader();
      reader.onload = (e) => {
        const previewImage = imageId === 1 ? elements.previewImage1 : elements.previewImage2;
        const previewContainer = imageId === 1 ? elements.previewContainer1 : elements.previewContainer2;
        
        previewImage.src = e.target.result;
        previewImage.onload = () => {
          // 存储图片尺寸
          state.images[imageId].width = previewImage.naturalWidth;
          state.images[imageId].height = previewImage.naturalHeight;
          
          // 显示预览
          previewContainer.classList.remove('hidden');
          
          // 上传到腾讯云COS
          uploadToCOS(file, imageId);
        };
      };
      reader.readAsDataURL(file);
      
      // 保存文件信息
      state.images[imageId].file = file;
    }

    // 上传文件到腾讯云COS
    function uploadToCOS(file, imageId) {
      if (!state.cos) {
        showError(imageId, 'Object storage service initialization failed, please refresh the page and try again');
        return;
      }
      
      // 配置COS参数
      const bucket = 'dfi-image-1365084971'; // 替换为你的存储桶名称
      const region = 'ap-hongkong'; // 替换为你的存储桶所在区域
      
      // 生成唯一的文件名
      const timestamp = new Date().getTime();
      const fileExt = file.name.split('.').pop();
      const cosKey = `image-diff-analysis/${timestamp}-${Math.random().toString(36).substr(2, 8)}.${fileExt}`;
      
      // 获取DOM元素
      const progressBar = imageId === 1 ? elements.progressBar1 : elements.progressBar2;
      const progressPercent = imageId === 1 ? elements.progressPercent1 : elements.progressPercent2;
      const progressContainer = imageId === 1 ? elements.progressContainer1 : elements.progressContainer2;
      
      // 调用COS SDK上传文件
      state.cos.putObject({
        Bucket: bucket,
        Region: region,
        Key: cosKey,
        Body: file,
        onProgress: function (progressData) {
          // 更新上传进度
          const percent = Math.round(progressData.percent * 100);
          progressBar.style.width = `${percent}%`;
          progressPercent.textContent = `${percent}%`;
        }
      }, function (err, data) {
        if (err) {
          // 上传失败
          console.error('COS上传失败:', err);
          showError(imageId, `Upload failed: ${err.Message || 'Unknown error'}`);
          return;
        }
        
        // 上传成功，隐藏上传进度
        progressContainer.classList.add('hidden');
        elements[`uploadSuccess${imageId}`].classList.remove('hidden');
        
        // 计算文件的访问URL
        const fileUrl = `https://${bucket}.cos.${region}.myqcloud.com/${cosKey}`;
        
        // 更新状态
        state.images[imageId].uploaded = true;
        state.images[imageId].url = fileUrl;
        state.images[imageId].cosKey = cosKey;
        
        // 上传成功后调用OCR接口
        callOcrApi(imageId, fileUrl);
      });
    }

    // 调用OCR API
    function callOcrApi(imageId, imageUrl) {
      // 显示OCR处理状态
      elements[`ocrProcessing${imageId}`].classList.remove('hidden');
      elements[`uploadSuccess${imageId}`].classList.add('hidden');
      
      // 实际应用中，应通过后端API调用腾讯云OCR，避免前端暴露密钥
      // 这里前端调用自己的后端服务，再由后端调用腾讯云OCR API
      fetch('http://150.109.72.200/api/recognize-image', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          imageUrl: imageUrl
        })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(result => {
        // 检查后端返回的错误
        if (result.error) {
          throw new Error(result.error);
        }
        
        // 隐藏处理状态，显示成功状态
        elements[`ocrProcessing${imageId}`].classList.add('hidden');
        elements[`ocrSuccess${imageId}`].classList.remove('hidden');
        
        // 保存OCR结果
        state.images[imageId].ocrCompleted = true;
        state.images[imageId].ocrResult = result;
        
        // 检查是否可以启用分析按钮
        checkAnalyzeButton();
      })
      .catch(error => {
        console.error('OCR识别失败:', error);
        
        // 隐藏处理状态，显示错误状态
        elements[`ocrProcessing${imageId}`].classList.add('hidden');
        elements[`ocrError${imageId}`].classList.remove('hidden');
        
        // 根据错误类型显示不同的错误信息
        let errorMessage = 'Text recognition failed: ';
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          errorMessage += 'Network connection failed, please check your internet connection';
        } else if (error.message.includes('429')) {
          errorMessage += 'Too many requests, please try again later';
        } else if (error.message.includes('500')) {
          errorMessage += 'Server internal error, please try again later';
        } else if (error.message.includes('timeout')) {
          errorMessage += 'Request timeout, please try again';
        } else {
          errorMessage += error.message || 'Unknown error';
        }
        
        elements[`ocrErrorMessage${imageId}`].textContent = errorMessage;
        
        // 重置OCR状态
        state.images[imageId].ocrCompleted = false;
        state.images[imageId].ocrResult = null;
        
        // 检查分析按钮状态
        checkAnalyzeButton();
      });
    }

    // 移除图片
    function removeImage(imageId) {
      // 如果已经上传到COS，删除COS中的文件
      if (state.images[imageId].uploaded && state.images[imageId].cosKey && state.cos) {
        const bucket = 'dfi-image-1365084971';
        const region = 'ap-hongkong';
        
        state.cos.deleteObject({
          Bucket: bucket,
          Region: region,
          Key: state.images[imageId].cosKey
        }, function (err, data) {
          if (err) {
            console.warn('删除COS文件失败:', err);
          }
        });
      }
      
      // 重置UI状态
      resetImageState(imageId);
      
      // 重置文件输入
      elements[`imageInput${imageId}`].value = '';
      
      // 更新状态
      state.images[imageId] = {
        file: null,
        url: null,
        uploaded: false,
        ocrCompleted: false,
        ocrResult: null,
        width: 0,
        height: 0,
        cosKey: null
      };
      
      // 检查分析按钮状态
      checkAnalyzeButton();
    }

    // 重置图片状态
    function resetImageState(imageId) {
      elements[`progressContainer${imageId}`].classList.add('hidden');
      elements[`previewContainer${imageId}`].classList.add('hidden');
      elements[`uploadSuccess${imageId}`].classList.add('hidden');
      elements[`uploadError${imageId}`].classList.add('hidden');
      elements[`ocrProcessing${imageId}`].classList.add('hidden');
      elements[`ocrSuccess${imageId}`].classList.add('hidden');
      elements[`ocrError${imageId}`].classList.add('hidden');
      elements[`progressBar${imageId}`].style.width = '0%';
      elements[`progressPercent${imageId}`].textContent = '0%';
    }

    // 显示错误信息
    function showError(imageId, message) {
      elements[`uploadError${imageId}`].classList.remove('hidden');
      elements[`errorMessage${imageId}`].textContent = message;
      
      // 重置文件输入
      elements[`imageInput${imageId}`].value = '';
      
      // 重置状态
      state.images[imageId].file = null;
    }

    // 显示全局错误
    function showGlobalError(message) {
      elements.uploadPage.classList.add('hidden');
      elements.errorState.classList.remove('hidden');
      elements.errorStateMessage.textContent = message;
    }

    // 检查分析按钮是否可以启用（需两张图片都完成OCR）
    function checkAnalyzeButton() {
      const bothOcrCompleted = state.images[1].ocrCompleted && state.images[2].ocrCompleted;
      elements.analyzeBtn.disabled = !bothOcrCompleted;
    }

    // 开始分析
    function startAnalysis() {
      // 显示分析进度
      elements.uploadPage.classList.add('hidden');
      elements.analysisProgress.classList.remove('hidden');
      
      // 调用差异分析API，传入OCR结果
      const analysisData = {
        image1: {
          url: state.images[1].url,
          ocrResult: state.images[1].ocrResult
        },
        image2: {
          url: state.images[2].url,
          ocrResult: state.images[2].ocrResult
        }
      };
      
      // 调用分析API
      callAnalysisApi(analysisData)
        .then(results => {
          state.analysisResults = results;
          
          // 隐藏分析进度，显示结果页面
          elements.analysisProgress.classList.add('hidden');
          showResultPage();
        })
        .catch(error => {
          console.error('分析失败:', error);
          elements.analysisProgress.classList.add('hidden');
          elements.errorState.classList.remove('hidden');
          elements.errorStateMessage.textContent = `Analysis failed: ${error.message || 'Unknown error'}`;
        });
    }

    // 调用差异分析API
    function callAnalysisApi(data) {
      // 准备调用ADP智能体的文件对话API
      console.log('调用ADP智能体文件对话API:', data);
      
      // 将OCR结果转换为文档格式
      // const document1 = convertOcrToDocument(data.image1.ocrResult);
      // const document2 = convertOcrToDocument(data.image2.ocrResult);
      
      // 调用后端API，由后端调用ADP智能体
      return fetch('http://150.109.72.200/api/compare-documents', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          image1Result: data.image1.ocrResult,
          image2Result: data.image2.ocrResult,
        })
        // body: JSON.stringify({
        //   document1: document1,
        //   document2: document2,
        //   image1Url: data.image1.url,
        //   image2Url: data.image2.url
        // })
      })
      .then(response => {
        if (!response.ok) throw new Error('Analysis request failed');
        return response.json();
      });
    }

    // 将OCR结果转换为文档格式
    function convertOcrToDocument(ocrResult) {
      // 根据您的OCR返回结构调整此函数
      // 假设OCR返回格式为: { words: [{ text: string, x: number, y: number, width: number, height: number }] }
      return {
        content: ocrResult.words.map(word => word.text).join(' '),
        textBlocks: ocrResult.words.map(word => ({
          text: word.text,
          position: {
            x: word.x,
            y: word.y,
            width: word.width,
            height: word.height
          }
        }))
      };
    }

    // 显示结果页面
    function showResultPage() {
      if (!state.analysisResults) {
        elements.errorState.classList.remove('hidden');
        return;
      }
      
      // 设置结果图片
      elements.resultImage1.src = state.images[1].url;
      elements.resultImage2.src = state.images[2].url;
      
      // 渲染差异标记
      renderDiffMarkers();
      
      // 渲染差异列表
      renderDifferencesList();
      
      // 适应屏幕显示
      fitToScreen();
      console.log('setTimeout 1000 resetZoom')
      setTimeout(() => {
        resetZoom()
      }, 1000);
      
      // 显示结果页面
      elements.resultPage.classList.remove('hidden');
    }

    // 渲染差异标记
    function renderDiffMarkers() {
      // 清空现有标记
      elements.diffMarkers1.innerHTML = '';
      elements.diffMarkers2.innerHTML = '';
      
      if (!state.analysisResults || !state.analysisResults.differences.length) {
        elements.noDifferences.classList.remove('hidden');
        return;
      }
      
      // 为每个差异创建标记
      state.analysisResults.differences.forEach(diff => {
        // 第一张图片的差异标记
        const marker1 = document.createElement('div');
        if(diff.image1){
          marker1.className = 'diff-marker';
          marker1.style.left = `${diff.image1.x}px`;
          marker1.style.top = `${diff.image1.y}px`;
          marker1.style.width = `${diff.image1.width}px`;
          marker1.style.height = `${diff.image1.height}px`;
          marker1.dataset.diffId = diff.id;
          elements.diffMarkers1.appendChild(marker1);
        }
        
        // 第二张图片的差异标记
        const marker2 = document.createElement('div');
        if(diff.image2){
        marker2.className = 'diff-marker';
        marker2.style.left = `${diff.image2.x}px`;
        marker2.style.top = `${diff.image2.y}px`;
        marker2.style.width = `${diff.image2.width}px`;
        marker2.style.height = `${diff.image2.height}px`;
        marker2.dataset.diffId = diff.id;
        elements.diffMarkers2.appendChild(marker2);
        }
      });
    }

    // 渲染差异列表
    function renderDifferencesList() {
      elements.differencesList.innerHTML = '';
      
      if (!state.analysisResults || !state.analysisResults.differences.length) {
        return;
      }
      
      // 为每个差异创建列表项
      state.analysisResults.differences.forEach((diff, index) => {
        const diffItem = document.createElement('div');
        diffItem.className = 'p-4 border border-gray-100 rounded-lg hover:border-primary/30 hover:bg-primary/5 transition-colors';
        diffItem.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <h4 class="font-semibold">Difference #${index + 1}</h4>
            <button class="text-primary hover:text-primary/80 text-sm focus:outline-none" data-diff-id="${diff.id}">
              <i class="fa fa-eye mr-1"></i>View Location
            </button>
          </div>
          <div class="space-y-2 text-sm">
            <div>
              <span class="text-gray-500">Reference Image:</span>
              <span class="ml-2 font-medium">${diff.image1 ? diff.image1.text : ''}</span>
            </div>
            <div>
              <span class="text-gray-500">Comparison Image:</span>
              <span class="ml-2 font-medium text-danger">${diff.image2 ? diff.image2.text : ''}</span>
            </div>
          </div>
        `;
        
        elements.differencesList.appendChild(diffItem);
        
        // 添加查看位置事件
        const viewBtn = diffItem.querySelector('button');
        viewBtn.addEventListener('click', (e) => {
          const diffId = e.currentTarget.dataset.diffId;
          highlightDiffMarker(diffId);
        });
      });
    }

    // 高亮显示差异标记
    function highlightDiffMarker(diffId) {
      // 移除所有高亮
      document.querySelectorAll('.diff-marker').forEach(marker => {
        marker.classList.remove('ring-4', 'ring-danger/50', 'animate-pulse');
      });
      
      // 添加高亮到指定差异
      document.querySelectorAll(`.diff-marker[data-diff-id="${diffId}"]`).forEach(marker => {
        marker.classList.add('ring-4', 'ring-danger/50', 'animate-pulse');
        
        // 自动滚动到标记位置
        const rect = marker.getBoundingClientRect();
        const container = marker.parentElement.parentElement;
        container.scrollTo({
          left: rect.left - container.offsetWidth / 2 + rect.width / 2,
          top: rect.top - container.offsetHeight / 2 + rect.height / 2,
          behavior: 'smooth'
        });
      });
      
      // 3秒后移除高亮动画
      setTimeout(() => {
        document.querySelectorAll(`.diff-marker[data-diff-id="${diffId}"]`).forEach(marker => {
          marker.classList.remove('animate-pulse');
        });
      }, 3000);
    }

    // 设置图片拖拽功能
    function setupImageDrag() {
      const containers = [
        elements.resultImage1.parentElement,
        elements.resultImage2.parentElement
      ];
      
      containers.forEach(container => {
        container.addEventListener('mousedown', startDrag);
        container.addEventListener('touchstart', startDrag, { passive: true });
      });
      
      document.addEventListener('mousemove', drag);
      document.addEventListener('touchmove', drag, { passive: false });
      document.addEventListener('mouseup', endDrag);
      document.addEventListener('touchend', endDrag);
    }

    // 开始拖拽
    function startDrag(e) {
      e.preventDefault();
      
      state.isDragging = true;
      
      // 记录初始位置
      if (e.type === 'mousedown') {
        state.dragStart.x = e.clientX - state.currentPosition.x;
        state.dragStart.y = e.clientY - state.currentPosition.y;
      } else { // touchstart
        state.dragStart.x = e.touches[0].clientX - state.currentPosition.x;
        state.dragStart.y = e.touches[0].clientY - state.currentPosition.y;
      }
      
      // 添加拖拽样式
      document.body.style.cursor = 'grabbing';
    }

    // 拖拽中
    function drag(e) {
      if (!state.isDragging) return;
      
      e.preventDefault();
      
      // 计算新位置
      let newX, newY;
      if (e.type === 'mousemove') {
        newX = e.clientX - state.dragStart.x;
        newY = e.clientY - state.dragStart.y;
      } else { // touchmove
        newX = e.touches[0].clientX - state.dragStart.x;
        newY = e.touches[0].clientY - state.dragStart.y;
      }
      
      // 更新位置
      state.currentPosition.x = newX;
      state.currentPosition.y = newY;
      
      // 应用位置变化
      updateImagePosition();
    }

    // 结束拖拽
    function endDrag() {
      state.isDragging = false;
      document.body.style.cursor = '';
    }

    // 放大图片
    function zoomIn() {
      state.currentZoom = Math.min(state.currentZoom + 0.1, 3); // 最大放大到3倍
      updateImagePosition();
    }

    // 缩小图片
    function zoomOut() {
      state.currentZoom = Math.max(state.currentZoom - 0.1, 0.3); // 最小缩小到0.3倍
      updateImagePosition();
    }

    // 重置缩放和位置
    function resetZoom() {
      state.currentZoom = 1;
      state.currentPosition = { x: 0, y: 0 };
      updateImagePosition();
    }

    // 适应屏幕显示
    function fitToScreen() {
      // 获取容器尺寸
      const containerWidth = elements.resultImage1.parentElement.clientWidth;
      const containerHeight = elements.resultImage1.parentElement.clientHeight;
      
      // 计算缩放比例
      const scaleX = containerWidth / state.images[1].width;
      const scaleY = containerHeight / state.images[1].height;
      state.currentZoom = Math.min(scaleX, scaleY, 1); // 不超过原尺寸
      
      // 居中显示
      state.currentPosition = {
        x: (containerWidth - state.images[1].width * state.currentZoom) / 2,
        y: (containerHeight - state.images[1].height * state.currentZoom) / 2
      };
      
      updateImagePosition();
    }

    // 更新图片位置和缩放
    function updateImagePosition() {
      // 应用到两张图片
      [elements.resultImage1, elements.resultImage2].forEach(image => {
        image.style.transform = `translate(${state.currentPosition.x}px, ${state.currentPosition.y}px) scale(${state.currentZoom})`;
      });
      
      // 应用到差异标记
      [elements.diffMarkers1, elements.diffMarkers2].forEach(markerContainer => {
        markerContainer.style.transform = `translate(${state.currentPosition.x}px, ${state.currentPosition.y}px) scale(${state.currentZoom})`;
        markerContainer.style.transformOrigin = '0 0';
      });
    }

    // 显示上传页面
    function showUploadPage() {
      // 隐藏其他页面
      elements.resultPage.classList.add('hidden');
      elements.errorState.classList.add('hidden');
      elements.analysisProgress.classList.add('hidden');
      
      // 显示上传页面
      elements.uploadPage.classList.remove('hidden');
    }

    // 下载分析报告
    function downloadReport() {
      if (!state.analysisResults) return;
      
      // 模拟生成报告内容
      let reportContent = "Image Difference Comparison Analysis Report\n";
      reportContent += "==========================================\n\n";
      reportContent += `Analysis Time: ${new Date().toLocaleString()}\n\n`;
      
      if (state.analysisResults.differences.length === 0) {
        reportContent += "No text differences found between the two images.\n";
      } else {
        reportContent += `Total ${state.analysisResults.differences.length} differences found:\n\n`;
        
        state.analysisResults.differences.forEach((diff, index) => {
          reportContent += `Difference #${index + 1}:\n`;
          reportContent += `  Reference Image: ${diff.image1?.text || ''}\n`;
          reportContent += `  Comparison Image: ${diff.image2?.text || ''}\n\n`;
        });
      }
      
      // 创建并下载报告文件
      const blob = new Blob([reportContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Image_Difference_Analysis_Report_${new Date().getTime()}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // 初始化应用
    async function init() {
      await initEventListeners();
      showUploadPage();
    }

    // 启动应用
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>